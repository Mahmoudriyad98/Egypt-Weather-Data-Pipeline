
  
    

        create or replace transient table EGYPT_WEATHER_DB.gold.fact_solar_energy
         as
        (

WITH solar_energy_data AS (
    SELECT
        se.*,
        dg.GOVERNORATE_KEY,
        dd.DATE_KEY,
        TO_NUMBER(TO_CHAR(se.DATETIME, 'HH24')) AS HOUR_OF_DAY
    FROM EGYPT_WEATHER_DB.silver.silver_solar_energy se
    LEFT JOIN EGYPT_WEATHER_DB.gold.dim_governorate dg 
        ON se.GOVERNORATE = dg.GOVERNORATE_NAME
    LEFT JOIN EGYPT_WEATHER_DB.gold.dim_date dd 
        ON DATE(se.DATETIME) = dd.DATE_VALUE
)

SELECT
    ROW_NUMBER() OVER (ORDER BY DATETIME, GOVERNORATE) AS SOLAR_ENERGY_KEY,
    GOVERNORATE_KEY,
    DATE_KEY,
    DATETIME,
    HOUR_OF_DAY,
    ALL_SKY_SURFACE_SHORTWAVE_DOWNWARD,
    CLEAR_SKY_SURFACE_SHORTWAVE_DOWNWARD,
    ALL_SKY_SURFACE_SHORTWAVE_DIRECT_NORMAL,
    ALL_SKY_SURFACE_SHORTWAVE_DIFFUSE,
    ALL_SKY_SURFACE_PAR_TOTAL,
    CLEAR_SKY_SURFACE_PAR_TOTAL,
    ALL_SKY_SURFACE_UVA,
    ALL_SKY_SURFACE_UVB,
    ALL_SKY_SURFACE_UV_INDEX,
    CASE
        WHEN ALL_SKY_SURFACE_UV_INDEX <= 2 THEN 'Low'
        WHEN ALL_SKY_SURFACE_UV_INDEX <= 5 THEN 'Moderate'
        WHEN ALL_SKY_SURFACE_UV_INDEX <= 7 THEN 'High'
        WHEN ALL_SKY_SURFACE_UV_INDEX <= 10 THEN 'Very High'
        WHEN ALL_SKY_SURFACE_UV_INDEX > 10 THEN 'Extreme'
        ELSE 'Unknown'
    END AS UV_INDEX_CATEGORY,
    LOAD_TIMESTAMP,
    TRANSFORM_TIMESTAMP,
    CURRENT_TIMESTAMP() AS CREATED_AT
FROM solar_energy_data
WHERE GOVERNORATE_KEY IS NOT NULL
ORDER BY DATETIME, GOVERNORATE
        );
      
  